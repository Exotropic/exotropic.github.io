<script>
// Admin credentials
const USERNAME = "EXOTROPIC";
const PASSWORD = "CANADAEXOTROPIC";

// Cloudinary settings
const CLOUD_NAME = "dgmg1cubi";
const UPLOAD_PRESET = "unsigned_products";

// Elements
const usernameInput = document.getElementById("username");
const passwordInput = document.getElementById("password");
const loginBtn = document.getElementById("loginBtn");
const togglePassword = document.getElementById("togglePassword");
const loginForm = document.getElementById("loginForm");
const adminSettings = document.getElementById("adminSettings");
const logoutBtn = document.getElementById("logoutBtn");
const imageInput = document.getElementById("imageInput");
const previewContainer = document.getElementById("previewContainer");

// Load previously uploaded images from localStorage
let uploadedImages = JSON.parse(localStorage.getItem("uploadedImages") || "[]");

// Show/hide password
togglePassword.addEventListener("click", () => {
  passwordInput.type = passwordInput.type === "password" ? "text" : "password";
  togglePassword.textContent = passwordInput.type === "password" ? "Show Password" : "Hide Password";
});

// Login functions
function showAdmin() {
  loginForm.style.display = "none";
  adminSettings.style.display = "block";
  logoutBtn.style.display = "inline-block";
  updatePreview();
}

loginBtn.addEventListener("click", () => {
  if(usernameInput.value === USERNAME && passwordInput.value === PASSWORD){
    localStorage.setItem("isLoggedIn", "true");
    showAdmin();
  } else alert("Incorrect username or password!");
});

if(localStorage.getItem("isLoggedIn") === "true") showAdmin();

logoutBtn.addEventListener("click", () => {
  localStorage.removeItem("isLoggedIn");
  location.reload();
});

// Update preview function
function updatePreview() {
  previewContainer.innerHTML = "";
  uploadedImages.forEach((url, index) => {
    const div = document.createElement("div");
    div.className = "preview-item";
    div.innerHTML = `<img src="${url}" alt="Product"><button class="delete-btn" data-index="${index}">&times;</button>`;
    previewContainer.appendChild(div);
  });

  document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const idx = btn.getAttribute("data-index");
      uploadedImages.splice(idx, 1); // Remove from array
      localStorage.setItem("uploadedImages", JSON.stringify(uploadedImages)); // Save updated array
      updatePreview(); // Refresh preview
    });
  });
}

// Upload images to Cloudinary and keep them in preview
imageInput.addEventListener("change", () => {
  const files = Array.from(imageInput.files);
  files.forEach(file => {
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", UPLOAD_PRESET);

    fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {
      method: "POST",
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      uploadedImages.push(data.secure_url); // Add to array
      localStorage.setItem("uploadedImages", JSON.stringify(uploadedImages)); // Persist
      updatePreview(); // Show immediately
    })
    .catch(err => console.error("Upload error:", err));
  });
  imageInput.value = ""; // Clear file input
});

// Initial render on page load
updatePreview();

// Save button ensures persistent storage
document.getElementById("addBtn").addEventListener("click", () => {
  localStorage.setItem("uploadedImages", JSON.stringify(uploadedImages));
  alert("All uploaded images saved. You can delete any image anytime using the preview delete button.");
});
</script>
