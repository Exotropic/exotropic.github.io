<script>
// --- Admin Credentials ---
const USERNAME = "EXOTROPIC";
const PASSWORD = "CANADAEXOTROPIC";

// --- Cloudinary Settings ---
const CLOUD_NAME = "dgmg1cubi";
const UPLOAD_PRESET = "unsigned_products";   // For images
const JSON_UPLOAD_PRESET = "unsigned_json";  // For catalog JSON
const JSON_PUBLIC_ID = "products";           // Fixed public ID
const JSON_FILENAME = "products.json";       // JSON file name

// --- Elements ---
const usernameInput = document.getElementById("username");
const passwordInput = document.getElementById("password");
const loginBtn = document.getElementById("loginBtn");
const togglePassword = document.getElementById("togglePassword");
const loginForm = document.getElementById("loginForm");
const adminSettings = document.getElementById("adminSettings");
const logoutBtn = document.getElementById("logoutBtn");
const imageInput = document.getElementById("imageInput");
const previewContainer = document.getElementById("previewContainer");
const addBtn = document.getElementById("addBtn");

// --- Store all uploaded images ---
let uploadedImages = [];

// --- Show/Hide Password ---
togglePassword.addEventListener("click", () => {
  passwordInput.type = passwordInput.type === "password" ? "text" : "password";
  togglePassword.textContent = passwordInput.type === "password" ? "Show Password" : "Hide Password";
});

// --- Login ---
function showAdmin() {
  loginForm.style.display = "none";
  adminSettings.style.display = "block";
  logoutBtn.style.display = "inline-block";
  loadCatalog(); // Load existing JSON
}

loginBtn.addEventListener("click", () => {
  if(usernameInput.value === USERNAME && passwordInput.value === PASSWORD){
    localStorage.setItem("isLoggedIn", "true");
    showAdmin();
  } else alert("Incorrect username or password!");
});

if(localStorage.getItem("isLoggedIn") === "true") showAdmin();

logoutBtn.addEventListener("click", () => {
  localStorage.removeItem("isLoggedIn");
  location.reload();
});

// --- Load existing JSON catalog ---
async function loadCatalog() {
  try {
    const res = await fetch(`https://res.cloudinary.com/${CLOUD_NAME}/raw/upload/${JSON_PUBLIC_ID}.json?t=${new Date().getTime()}`);
    if(res.ok){
      uploadedImages = await res.json();
    } else {
      uploadedImages = [];
    }
  } catch(e) {
    uploadedImages = [];
    console.warn("No existing catalog found, starting fresh.");
  }
  updatePreview();
}

// --- Update preview ---
function updatePreview() {
  previewContainer.innerHTML = "";
  uploadedImages.forEach((url, index) => {
    const div = document.createElement("div");
    div.className = "preview-item";
    div.innerHTML = `<img src="${url}" alt="Product">
                     <button class="delete-btn" data-index="${index}">&times;</button>`;
    previewContainer.appendChild(div);
  });

  document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const idx = btn.getAttribute("data-index");
      uploadedImages.splice(idx, 1);
      updatePreview();
      uploadCatalogJSON(); // Save JSON after deletion
    });
  });
}

// --- Upload Images to Cloudinary ---
imageInput.addEventListener("change", async () => {
  const files = Array.from(imageInput.files);
  if(files.length > 10){ alert("Max 10 images at a time"); imageInput.value = ""; return; }

  for(const file of files){
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", UPLOAD_PRESET);

    try {
      const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {
        method: "POST", body: formData
      });
      const data = await res.json();
      uploadedImages.push(data.secure_url);
      updatePreview();
    } catch(err) { console.error("Upload error:", err); }
  }

  uploadCatalogJSON(); // Save JSON after uploads
  imageInput.value = "";
});

// --- "Add to Website" button ---
addBtn.addEventListener("click", () => {
  uploadCatalogJSON();
  alert("Catalog updated!");
});

// --- Upload Catalog JSON to Cloudinary (overwrite old JSON) ---
async function uploadCatalogJSON() {
  const blob = new Blob([JSON.stringify(uploadedImages, null, 2)], { type: "application/json" });
  const formData = new FormData();
  formData.append("file", blob, JSON_FILENAME);
  formData.append("upload_preset", JSON_UPLOAD_PRESET);
  formData.append("public_id", JSON_PUBLIC_ID); // Overwrite existing JSON

  try {
    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {
      method: "POST", body: formData
    });
    const data = await res.json();
    console.log("Catalog JSON updated:", data.secure_url);
  } catch(err) { console.error("Failed to upload catalog JSON:", err); }
}
</script>
